// Multi-tenant Anamnese PaaS V2 - Prisma Schema
// RLS is applied via init-rls.sql; Prisma does not set session variable automatically.
// All routes must validate x-tenant-id and queries must include tenantId in where clauses.

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String    @id @default(cuid())
  name      String
  status    String    @default("active") // active | suspended
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  memberships Membership[]
  anamnesisTemplates AnamnesisTemplate[]
  anamnesisSessions  AnamnesisSession[]
  anamnesisAnswers   AnamnesisAnswer[]
  aiInsights         AiInsight[]
  auditLogs          AuditLog[]
  idempotencyKeys    IdempotencyKey[]
  refreshTokens      RefreshToken[]

  @@map("tenants")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  passwordHash String @map("password_hash")
  name      String?
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  memberships   Membership[]
  auditLogs     AuditLog[]     @relation("AuditActor")
  refreshTokens RefreshToken[]

  @@map("users")
}

model Membership {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   // owner | admin | practitioner | viewer
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("memberships")
}

model AnamnesisTemplate {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  name      String
  version   Int       @default(1)
  schemaJson Json     @map("schema_json") // { questions, conditionalLogic, tags }
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions AnamnesisSession[]

  @@index([tenantId, createdAt])
  @@map("anamnesis_templates")
}

model AnamnesisSession {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  templateId String    @map("template_id")
  subjectId  String?   @map("subject_id") // optional external subject ref
  status     String    @default("in_progress") // in_progress | completed
  createdAt  DateTime  @default(now()) @map("created_at")
  deletedAt  DateTime? @map("deleted_at")

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template AnamnesisTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  answers  AnamnesisAnswer[]
  aiInsights AiInsight[]

  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([templateId])
  @@map("anamnesis_sessions")
}

model AnamnesisAnswer {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  sessionId  String   @map("session_id")
  answersJson Json    @map("answers_json") // { questionId: value, ... }
  createdAt  DateTime @default(now()) @map("created_at")

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session AnamnesisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([tenantId])
  @@map("anamnesis_answers")
}

model AiInsight {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  sessionId          String   @map("session_id")
  summary            String?  @db.Text
  risksJson          Json     @map("risks_json") // { readiness, dropoutRisk, stress, sleepQuality } 0-100
  recommendationsJson Json    @map("recommendations_json") // string[]
  createdAt          DateTime @default(now()) @map("created_at")

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session AnamnesisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId])
  @@index([tenantId])
  @@map("ai_insights")
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  actorUserId String?  @map("actor_user_id")
  action      String   // create | update | delete | login | etc
  entity      String   // tenant | user | template | session | ...
  entityId    String?  @map("entity_id")
  metadataJson Json?   @map("metadata_json")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
  @@index([tenantId, entity])
  @@index([actorUserId])
  @@map("audit_log")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tenantId  String    @map("tenant_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, tenantId])
  @@map("refresh_tokens")
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  key          String
  requestHash  String   @map("request_hash")
  responseJson Json?    @map("response_json")
  statusCode   Int      @map("status_code")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([createdAt]) // para cleanup de keys expiradas
  @@map("idempotency_keys")
}
