// Multi-tenant Anamnese PaaS V2 - Prisma Schema
// RLS is applied via init-rls.sql; Prisma does not set session variable automatically.
// All routes must validate x-tenant-id and queries must include tenantId in where clauses.

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["debian-openssl-3.0.x", "native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String    @id @default(cuid())
  name      String
  status    String    @default("active") // active | suspended
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  // Billing (Stripe subscription)
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  subscriptionStatus   String?   @map("subscription_status") // active | past_due | canceled | trialing
  currentPeriodEnd     DateTime? @map("current_period_end")
  // AI Cost Alerts
  aiCostLimitUsd       Float?    @map("ai_cost_limit_usd")
  aiCostAlertThreshold Float?    @map("ai_cost_alert_threshold") // percentage (0-100) of limit
  aiCostAlertSentAt    DateTime? @map("ai_cost_alert_sent_at")

  memberships Membership[]
  anamnesisTemplates AnamnesisTemplate[]
  anamnesisSessions  AnamnesisSession[]
  anamnesisAnswers   AnamnesisAnswer[]
  aiInsights         AiInsight[]
  aiUsageMetrics     AiUsageMetric[]
  aiCostAlerts       AiCostAlert[]
  auditLogs          AuditLog[]
  idempotencyKeys    IdempotencyKey[]
  refreshTokens      RefreshToken[]
  patients           Patient[]
  patientEvolutions PatientEvolution[]

  @@map("tenants")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  passwordHash String @map("password_hash")
  name      String?
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  // 2FA
  twoFactorSecret String? @map("two_factor_secret")
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  twoFactorBackupCodes String[] @map("two_factor_backup_codes")
  // Password policy
  passwordChangedAt DateTime? @map("password_changed_at")
  passwordExpiresAt DateTime? @map("password_expires_at")

  memberships   Membership[]
  auditLogs     AuditLog[]     @relation("AuditActor")
  refreshTokens RefreshToken[]
  passwordHistory PasswordHistory[]

  @@map("users")
}

model Membership {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   // owner | admin | practitioner | viewer
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, active])
  @@map("memberships")
}

model AnamnesisTemplate {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  name      String
  version   Int       @default(1)
  schemaJson Json     @map("schema_json") // { questions, conditionalLogic, tags }
  llmPrompt String?   @db.Text @map("llm_prompt") // Custom LLM prompt override
  llmFinetunedModel String?   @map("llm_finetuned_model") // Custom fine-tuned model ID for this template
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions AnamnesisSession[]

  @@index([tenantId, createdAt])
  @@map("anamnesis_templates")
}

model AnamnesisSession {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  templateId String    @map("template_id")
  subjectId  String?   @map("subject_id") // optional external subject ref
  patientId  String?   @map("patient_id") // cadastro completo do paciente (Medidas & Evolução)
  status     String    @default("in_progress") // in_progress | completed
  fillToken  String?   @unique @map("fill_token") // token para link público de preenchimento
  signatureName   String?   @map("signature_name")
  signatureAgreedAt DateTime? @map("signature_agreed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  deletedAt  DateTime? @map("deleted_at")

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template AnamnesisTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  patient  Patient?        @relation(fields: [patientId], references: [id], onDelete: SetNull)
  answers  AnamnesisAnswer[]
  aiInsights AiInsight[]
  aiUsageMetrics AiUsageMetric[]

  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([templateId])
  @@index([patientId])
  @@map("anamnesis_sessions")
}

// Cadastro completo do paciente (Medidas & Evolução)
model Patient {
  id             String    @id @default(cuid())
  tenantId       String    @map("tenant_id")
  fullName       String    @map("full_name")
  birthDate      DateTime? @map("birth_date")
  gender         String?   // M | F | Other | Prefer not to say
  cpf            String?   @unique
  email          String?
  phone          String?
  profession     String?   @map("profession")
  mainGoal       String?   @map("main_goal")   @db.Text
  mainComplaint  String?   @map("main_complaint") @db.Text
  notes          String?   @db.Text
  consentVersion    String?   @map("consent_version")   // versão do termo LGPD aceito
  consentAcceptedAt DateTime? @map("consent_accepted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  evolutions PatientEvolution[]
  sessions  AnamnesisSession[]

  @@index([tenantId])
  @@index([tenantId, fullName])
  @@map("patients")
}

// Registros de medidas e evolução ao longo do tempo
model PatientEvolution {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  patientId               String   @map("patient_id")
  recordedAt              DateTime @map("recorded_at") // data da consulta/registro
  weightKg                Float?   @map("weight_kg")
  heightCm                Float?   @map("height_cm")
  bmi                     Float?   // calculado ou armazenado
  waistCm                 Float?   @map("waist_cm")
  hipCm                   Float?   @map("hip_cm")
  waistHipRatio           Float?   @map("waist_hip_ratio")
  bodyFatPercent          Float?   @map("body_fat_percent")
  bloodPressureSystolic   Int?     @map("blood_pressure_systolic")
  bloodPressureDiastolic  Int?     @map("blood_pressure_diastolic")
  heartRateBpm            Int?     @map("heart_rate_bpm")
  notes                   String?  @db.Text
  createdAt               DateTime @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, recordedAt])
  @@index([tenantId])
  @@map("patient_evolutions")
}

model AnamnesisAnswer {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  sessionId  String   @map("session_id")
  answersJson Json    @map("answers_json") // { questionId: value, ... }
  createdAt  DateTime @default(now()) @map("created_at")

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session AnamnesisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([tenantId])
  @@map("anamnesis_answers")
}

model AiInsight {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  sessionId          String   @map("session_id")
  summary            String?  @db.Text
  risksJson          Json     @map("risks_json") // { readiness, dropoutRisk, stress, sleepQuality } 0-100
  recommendationsJson Json    @map("recommendations_json") // string[]
  answersHash        String?  @map("answers_hash") // SHA256 hash for similarity caching
  createdAt          DateTime @default(now()) @map("created_at")

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session AnamnesisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId])
  @@index([tenantId])
  @@index([answersHash])
  @@map("ai_insights")
}

model AiUsageMetric {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  sessionId       String   @map("session_id")
  provider        String   // openai | anthropic
  model           String
  inputTokens     Int      @default(0) @map("input_tokens")
  outputTokens    Int      @default(0) @map("output_tokens")
  estimatedCostUsd Float   @default(0) @map("estimated_cost_usd")
  createdAt       DateTime @default(now()) @map("created_at")

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session AnamnesisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("ai_usage_metrics")
}

model AiCostAlert {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  currentCostUsd  Float    @map("current_cost_usd")
  limitUsd        Float    @map("limit_usd")
  thresholdPercent Float   @map("threshold_percent")
  sentAt          DateTime @default(now()) @map("sent_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sentAt])
  @@map("ai_cost_alerts")
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  actorUserId String?  @map("actor_user_id")
  action      String   // create | update | delete | login | etc
  entity      String   // tenant | user | template | session | ...
  entityId    String?  @map("entity_id")
  metadataJson Json?   @map("metadata_json")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, action])
  @@index([tenantId, entity])
  @@index([actorUserId])
  @@map("audit_log")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tenantId  String    @map("tenant_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, tenantId])
  @@map("refresh_tokens")
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  key          String
  requestHash  String   @map("request_hash")
  responseJson Json?    @map("response_json")
  statusCode   Int      @map("status_code")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([createdAt]) // para cleanup de keys expiradas
  @@map("idempotency_keys")
}

model PasswordHistory {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  passwordHash String  @map("password_hash")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("password_history")
}
